{"name":"Свет","type":"virtual_device","properties":{"deviceIcon":0,"currentIcon":"0","log":"0.00Вт","logTemp":"TxtGreen","mainLoop":"local sum = 0;\nlocal names = \"\";\nlocal nodesID = { 41, 42, 43 }; -- БольшаяКомната-СветОсн24\nlocal nodesName = { \"Л\", \"Ц\", \"П\" };\n\nfor i = 1, #nodesID do\n  \n  local nodeID = nodesID[i];\n  local nodeValue = tonumber(fibaro:getValue(nodeID, \"value\"));\n  \n  if ( (nodeValue > 0) and (fibaro:getValue(nodeID, \"dead\") == \"0\") ) then\n    names = names .. nodesName[i];\n    \n    if (nodeValue >= 99) then\n      sum = sum + 100;\n    else\n      sum = sum + nodeValue;\n    end\n    --[[if (nodeValue > sum) then -- find MAX\n      sum = nodeValue;\n    end--]]\n  end\n  \nend\n\nlocal sliderPos = math.ceil(sum / #nodesID); --sum -- for MAX value\n\nif ( (sliderPos > 0) and (sliderPos < 3) ) then\n  sliderPos = 3;\nelseif ( sliderPos >= 99 ) then\n  sliderPos = 100;\nend\n\n--fibaro:debug(\"cur slider = \" ..\n--  fibaro:getValue(195, \"ui.Slider1.value\") .. \", calc sliderPos = \" .. tostring(sliderPos));\n\nfibaro:call(195, \"setProperty\", \"ui.Slider1.value\", tostring(sliderPos));\n--fibaro:call(195, \"setSlider\", \"1\", tostring(sliderPos));\n\nfibaro:call(195, \"setProperty\", \"ui.Label3.value\", names);\n\n-----\n\nlocal nodeID = 44;\nlocal nodeValue = tonumber(fibaro:getValue(nodeID, \"value\"));\n\nif ( nodeValue > 0 ) then\n  --fibaro:debug(\"#\" .. tostring(nodeID) .. \" value = \" .. tostring(nodeValue));\n  if ( fibaro:getValue(nodeID, \"dead\") ~= \"0\" ) then\n    --fibaro:debug(\"#\" .. tostring(nodeID) .. \" is DEAD!\");\n    nodeValue = 0;\n  elseif ( nodeValue >= 99 ) then\n    --fibaro:debug(\"#\" .. tostring(nodeID) .. \" is MAX\");\n    nodeValue = 100;\n  elseif ( nodeValue < 3 ) then\n    --fibaro:debug(\"#\" .. tostring(nodeID) .. \" is MIN\");\n    nodeValue = 3;\n  end\nend\n\n--fibaro:debug(\"cur slider = \" ..\n--  fibaro:getValue(195, \"ui.Slider2.value\") .. \", calc sliderPos = \" .. tostring(nodeValue));\n\nfibaro:call(195, \"setProperty\", \"ui.Slider2.value\", tostring(nodeValue));\n\nlocal powerValue = 0;\n\nif ( (fibaro:getValue(39, \"dead\") == \"0\")\n    and (fibaro:getValue(39, \"value\") ~= \"0\") ) then\n  powerValue = tonumber(fibaro:getValue(39, \"power\"));\nend\n\nif ( (fibaro:getValue(210, \"dead\") == \"0\")\n    and (fibaro:getValue(210, \"value\") ~= \"0\") ) then\n  powerValue = powerValue + tonumber(fibaro:getValue(210, \"power\"));\nend\n\nlocal power = string.format(\"%.2f\", powerValue);\n\nfibaro:call(195, \"setProperty\", \"ui.Label5.value\", power .. \"Вт\");\nfibaro:log(power .. \"Вт\");\n\n-----\n\nfibaro:sleep(5000);\n\n--[[\nlocal sum = 0;\nlocal switchedLightsID = { 148 }; -- БольшаяКомната-СветОсновной,центр\n\n\n-- PROCESS\n\nfor i = 1, #switchedLightsID do\n  \n  local nodeID = switchedLightsID[i];\n  local nodeValue = tonumber(fibaro:getValue(nodeID, \"value\"));\n  \n  if ( (nodeValue > 0) and (fibaro:getValue(nodeID, \"dead\") == \"0\") ) then\n    if (nodeValue >= 99) then\n      sum = sum + 100;\n    else\n      sum = sum + nodeValue;\n    end\n  end\n  \nend\n\nlocal sliderPos = tostring(math.floor(sum / #switchedLightsID));\n\nfibaro:debug(\"cur slider = \" ..\n  fibaro:getValue(196, \"ui.Slider1.value\") .. \", calc sliderPos = \" .. sliderPos);\n\nfibaro:call(196, \"setProperty\", \"ui.Slider1.value\", sliderPos);\n\nfibaro:sleep(3.5 * 1000); -- 3.5 sec\n--]]\n","ui.Label1.value":"","ui.Label3.value":"","ui.Label4.value":"","ui.Label5.value":"0.00Вт","ui.Slider1.value":0,"ui.Slider2.value":0,"visible":"true","rows":[{"type":"label","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"ОБЩИЙ","name":"Label1","favourite":false,"main":false}]},{"type":"button","elements":[{"id":2,"lua":true,"waitForResponse":false,"caption":"ВКЛ","name":"Button11","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"41,100;42,100;43,100;\");\n--fibaro:call(195, \"setProperty\", \"ui.Slider1.value\", \"100\");\n--fibaro:startScene(188);","buttonIcon":0,"favourite":false,"main":false},{"id":3,"lua":true,"waitForResponse":false,"caption":"МИН","name":"Button12","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"41,1;42,1;43,1;\");\n--fibaro:call(195, \"setProperty\", \"ui.Slider1.value\", \"1\");\n--fibaro:startScene(188);","buttonIcon":0,"favourite":false,"main":false},{"id":4,"lua":true,"waitForResponse":false,"caption":"ВЫКЛ","name":"Button13","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"40,0;\");\n--fibaro:call(195, \"setProperty\", \"ui.Slider1.value\", \"0\");\n--fibaro:startScene(188);","buttonIcon":0,"favourite":false,"main":false}]},{"type":"slider","elements":[{"id":5,"lua":true,"waitForResponse":false,"caption":"диммер","name":"Slider1","msg":"local lightAction = \"\";\n\nif ( fibaro:getValue(41, \"value\") ~= \"0\" ) then\n  lightAction = lightAction\n    .. \"41,\" .. _sliderValue_ .. \";\";\nend\n\nif ( fibaro:getValue(42, \"value\") ~= \"0\" ) then\n  lightAction = lightAction\n    .. \"42,\" .. _sliderValue_ .. \";\";\nend\n\nif ( fibaro:getValue(43, \"value\") ~= \"0\" ) then\n  lightAction = lightAction\n    .. \"43,\" .. _sliderValue_ .. \";\";\nend\n\nif ( lightAction == \"\" ) then\n  lightAction =\n\t\"41,\" .. _sliderValue_ .. \";\"\n\t.. \"42,\" .. _sliderValue_ .. \";\"\n\t.. \"43,\" .. _sliderValue_ .. \";\";\nend\n\nfibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  ..lightAction);\n\n--fibaro:startScene(188);\n","buttonIcon":0,"value":0,"favourite":false,"main":true}]},{"type":"button","elements":[{"id":6,"lua":true,"waitForResponse":false,"caption":"переключатель","name":"Button21","empty":false,"msg":"if ( (fibaro:getValue(40, \"value\") == \"0\")\n\tor (fibaro:getValue(40, \"dead\") ~= \"0\")\n\tor (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  ) then\n  \n  -- for wife pleasure ))\n  --[[fibaro:setGlobal(\"lightsQueue\", fibaro:getGlobalValue(\"lightsQueue\")\n  \t.. \"41,199;42,199;43,199;\");--]]\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"42,199;\");\n  \n  -- почему 199, а не 200? ибо непонятная хрень -\n  -- RGBW в БК не желают включаться по\n  -- \"turnOn\" (в т.ч. через моб.прил-ие!),\n  -- выключаются же при этом - без проблем..\n  \nelse\n  \n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"41,-1;42,-1;43,-1;\");\n  \nend\n--[[\n  if ( fibaro:getGlobalValue(\"nightMode\") == \"1\" ) then\n    fibaro:call(195, \"pressButton\", \"3\");\n  else\n    fibaro:call(195, \"pressButton\", \"2\");\n  end\nelse\n  fibaro:call(195, \"pressButton\", \"4\");\nend\n--]]\n","buttonIcon":0,"favourite":false,"main":true}]},{"type":"label","elements":[{"id":7,"lua":false,"waitForResponse":false,"caption":"- поканально:","name":"Label3","favourite":false,"main":false}]},{"type":"button","elements":[{"id":8,"lua":true,"waitForResponse":false,"caption":"слева","name":"Button31","empty":false,"msg":"if ( (fibaro:getValue(41, \"value\") == \"0\")\n\tor (fibaro:getValue(41, \"dead\") ~= \"0\")\n\tor (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  ) then\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n  \t.. \"41,100;\");\nelse\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"41,0;\");\nend","buttonIcon":0,"favourite":false,"main":false},{"id":9,"lua":true,"waitForResponse":false,"caption":"центр","name":"Button32","empty":false,"msg":"if ( (fibaro:getValue(42, \"value\") == \"0\")\n\tor (fibaro:getValue(42, \"dead\") ~= \"0\")\n\tor (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  ) then\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"42,100;\");\nelse\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"42,0;\");\nend","buttonIcon":0,"favourite":false,"main":false},{"id":10,"lua":true,"waitForResponse":false,"caption":"справа","name":"Button33","empty":false,"msg":"if ( (fibaro:getValue(43, \"value\") == \"0\")\n\tor (fibaro:getValue(43, \"dead\") ~= \"0\")\n\tor (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  )\nthen\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"43,100;\");\nelse\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"43,0;\");\nend","buttonIcon":0,"favourite":false,"main":false}]},{"type":"label","elements":[{"id":11,"lua":false,"waitForResponse":false,"caption":"ПРИКРОВАТНЫЙ","name":"Label4","favourite":false,"main":false}]},{"type":"button","elements":[{"id":12,"lua":true,"waitForResponse":false,"caption":"ВКЛ","name":"Button41","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"44,100;\");\n--fibaro:call(195, \"setProperty\", \"ui.Slider2.value\", \"100\");\n--fibaro:startScene(188);\n","buttonIcon":0,"favourite":false,"main":false},{"id":13,"lua":true,"waitForResponse":false,"caption":"МИН","name":"Button42","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"44,1;\");\n--fibaro:call(195, \"setProperty\", \"ui.Slider2.value\", \"1\");\n--fibaro:startScene(188);","buttonIcon":0,"favourite":false,"main":false},{"id":14,"lua":true,"waitForResponse":false,"caption":"ВЫКЛ","name":"Button43","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"44,0;\");\n--fibaro:call(195, \"setProperty\", \"ui.Slider2.value\", \"0\");\n--fibaro:startScene(188);\n","buttonIcon":0,"favourite":false,"main":false}]},{"type":"slider","elements":[{"id":15,"lua":true,"waitForResponse":false,"caption":"диммер","name":"Slider2","msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"44,\" .. _sliderValue_ .. \";\");\n--fibaro:startScene(188);\n","buttonIcon":0,"value":0,"favourite":false,"main":false}]},{"type":"button","elements":[{"id":16,"lua":true,"waitForResponse":false,"caption":"переключатель","name":"Button51","empty":false,"msg":"if ( (fibaro:getValue(44, \"value\") == \"0\")\n\tor (fibaro:getValue(44, \"dead\") ~= \"0\")\n\tor (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  ) then\n  local val = \"199\";\n  \n  local lightDecorID = 18;\n  local lightDecorPPBRID = 169; -- PPBR -> Play/Pause | BigRoom\n  \n  local switchDecorLight,\n    switchDecorLightModTime = fibaro:get(lightDecorID,\n    \"value\");\n  local switchBRDecorLight,\n    switchBRDecorLightModTime = fibaro:get(lightDecorPPBRID,\n    \"value\");\n  \n  if ( (tonumber(switchDecorLight) == 0)\n    or (switchBRDecorLightModTime <\n      switchDecorLightModTime) )\n  then\n    val = \"150\";\n  end\n\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n  \t.. \"44,\" .. val .. \";\");\nelse\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"44,0;\");\nend\n--[[\nif fibaro:getValue(195, \"ui.Slider2.value\") == \"0\"\nthen\n  if fibaro:getGlobalValue(\"nightMode\") == \"1\"\n  then\n    fibaro:call(195, \"pressButton\", \"10\");\n  else\n    fibaro:call(195, \"pressButton\", \"9\");\n  end\nelse\n  fibaro:call(195, \"pressButton\", \"11\");\nend\n--]]\n","buttonIcon":0,"favourite":false,"main":false}]},{"type":"label","elements":[{"id":17,"lua":false,"waitForResponse":false,"caption":"Потребление:","name":"Label5","favourite":false,"main":true}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}