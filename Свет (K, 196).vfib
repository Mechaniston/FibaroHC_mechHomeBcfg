{"name":"Свет","type":"virtual_device","properties":{"deviceIcon":0,"currentIcon":"0","log":"","logTemp":"","mainLoop":"local nodeID = 149;\nlocal nodeValue = tonumber(fibaro:getValue(nodeID, \"value\"));\n\nif (nodeValue > 0)\nthen\n  --fibaro:debug(\"#\" .. tostring(nodeID) .. \" value = \" .. tostring(nodeValue));\n  if (fibaro:getValue(nodeID, \"dead\") ~= \"0\")\n  then\n    --fibaro:debug(\"#\" .. tostring(nodeID) .. \" is DEAD!\");\n    nodeValue = 0;\n  elseif (nodeValue >= 99)\n  then\n    --fibaro:debug(\"#\" .. tostring(nodeID) .. \" is MAX\");\n    nodeValue = 100;\n  elseif (nodeValue < 3)\n  then\n    --fibaro:debug(\"#\" .. tostring(nodeID) .. \" is MIN\");\n    nodeValue = 3;\n  end\nend\n\nfibaro:call(196, \"setProperty\", \"ui.Slider1.value\", tostring(nodeValue));\n\nfibaro:sleep(5000);\n--]]\n\n--[[\nlocal sum = 0;\nlocal switchedLightsID = { 148 }; -- БольшаяКомната-СветОсновной,центр\n\n\n-- PROCESS\n\nfor i = 1, #switchedLightsID do\n  \n  local nodeID = switchedLightsID[i];\n  local nodeValue = tonumber(fibaro:getValue(nodeID, \"value\"));\n  \n  if ( (nodeValue > 0) and (fibaro:getValue(nodeID, \"dead\") == \"0\") ) then\n    if (nodeValue >= 99) then\n      sum = sum + 100;\n    else\n      sum = sum + nodeValue;\n    end\n  end\n  \nend\n\nlocal sliderPos = tostring(math.floor(sum / #switchedLightsID));\n\nfibaro:debug(\"cur slider = \" ..\n  fibaro:getValue(196, \"ui.Slider1.value\") .. \", calc sliderPos = \" .. sliderPos);\n\nfibaro:call(196, \"setProperty\", \"ui.Slider1.value\", sliderPos);\n\nfibaro:sleep(3.5 * 1000); -- 3.5 sec\n--]]\n","ui.Slider1.value":0,"visible":"true","rows":[{"type":"button","elements":[{"id":1,"lua":true,"waitForResponse":false,"caption":"ВКЛ","name":"Button11","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"149,100;\");\n\n--[[\nfibaro:call(196, \"setProperty\", \"ui.Slider1.value\", \"100\");\nfibaro:startScene(188);\n--]]\n\n--[\n\n-- CONST\n\nlocal powerID = 4; -- Туалет:БП ACDC 24В\nlocal switchedLightsID = { 148 }; -- КоридорКухня:СветОсновной_R_Кухня:СветОсновной\n\n\n-- PROCESS\n\nlocal powerIsOn = fibaro:getValue(powerID, \"value\");\n\nif tonumber(powerIsOn) == 0 then\n  \n  fibaro:debug(\"Power is OFF! Turning on\");\n  fibaro:log(\"Turning on Power\");\n  \n  fibaro:call(powerID, \"turnOn\");\n  fibaro:sleep(5000);\n  \nelse\n  fibaro:debug(\"Power is on\");\nend;\n\nlocal startWakeupTime = os.time();\n\nwhile os.time() < startWakeupTime + 15 do\n  \n  local isDead = false;\n  \n  for i = 1, #switchedLightsID do\n    \n    local nodeID = switchedLightsID[i];\n    \n    if fibaro:getValue(nodeID, \"dead\") >= \"1\" then\n      \n      fibaro:debug(\"Waking up <\" .. fibaro:getName(nodeID) .. \" (\" .. fibaro:getRoomNameByDeviceID(nodeID) .. \")>\");\n      fibaro:log(\"Waking up switches\");\n      \n      fibaro:wakeUpDeadDevice(nodeID);\n      isDead = true;\n      \n    end;\n    \n  end;\n  \n  if isDead == false then\n    break;\n  else\n    fibaro:sleep(3000);\n  end;\n  \nend;\n\nfibaro:log(\"Turning lishts ON\");\n\nfor i = 1, #switchedLightsID do\n  \n  local nodeID = switchedLightsID[i];\n  \n  fibaro:call(nodeID, \"turnOn\");\n  \n  fibaro:debug(\"Turning on <\" .. fibaro:getName(nodeID) .. \" (\" .. fibaro:getRoomNameByDeviceID(nodeID) .. \")> value = \" .. fibaro:getValue(nodeID, \"value\") ..\", deadflag = \" .. fibaro:getValue(nodeID, \"dead\"));\n  \nend;\n--]]","buttonIcon":0,"favourite":false,"main":false},{"id":2,"lua":true,"waitForResponse":false,"caption":"МИН","name":"Button12","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"149,1;\");\n\n--fibaro:call(196, \"setProperty\", \"ui.Slider1.value\", \"1\");\n--fibaro:startScene(188);\n--fibaro:call(196, \"setProperty\", \"ui.Slider1.value\", \"3\");\n\n--[\n-- CONST\n\nlocal powerID = 4; -- Туалет:БП ACDC 24В\nlocal switchedLightsID = { 148 }; -- КоридорКухня:СветОсновной_R_Кухня:СветОсновной\n\n\n-- PROCESS\n\nlocal powerIsOn = fibaro:getValue(powerID, \"value\");\n\nif tonumber(powerIsOn) == 0 then\n  \n  fibaro:debug(\"Power is OFF! Turning on\");\n  fibaro:log(\"Turning on Power\");\n  \n  fibaro:call(powerID, \"turnOn\");\n  fibaro:sleep(5000);\n  \nelse\n  fibaro:debug(\"Power is on\");\nend;\n\nlocal startWakeupTime = os.time();\n\nwhile os.time() < startWakeupTime + 15 do\n  \n  local isDead = false;\n  \n  for i = 1, #switchedLightsID do\n    \n    local nodeID = switchedLightsID[i];\n    \n    if fibaro:getValue(nodeID, \"dead\") >= \"1\" then\n      \n      fibaro:debug(\"Waking up <\" .. fibaro:getName(nodeID) .. \" (\" .. fibaro:getRoomNameByDeviceID(nodeID) .. \")>\");\n      fibaro:log(\"Waking up switches\");\n      \n      fibaro:wakeUpDeadDevice(nodeID);\n      isDead = true;\n      \n    end;\n    \n  end;\n  \n  if isDead == false then\n    break;\n  else\n    fibaro:sleep(3000);\n  end;\n  \nend;\n\nfibaro:log(\"Set MIN lights\");\n\nfor i = 1, #switchedLightsID do\n  \n  local nodeID = switchedLightsID[i];\n  \n  fibaro:call(nodeID, \"setValue\", \"1\");\n  \n  fibaro:debug(\"Set MIN value for <\" .. fibaro:getName(nodeID) .. \" (\" .. fibaro:getRoomNameByDeviceID(nodeID) .. \")>\");\n  \nend;\n--]]","buttonIcon":0,"favourite":false,"main":false},{"id":3,"lua":true,"waitForResponse":false,"caption":"ВЫКЛ","name":"Button13","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"149,0;\");\n\n--fibaro:call(196, \"setProperty\", \"ui.Slider1.value\", \"0\");\n--fibaro:startScene(188);\n\n--[[\n-- CONST\n\nlocal powerID = 4; -- Туалет:БП ACDC 24В\nlocal switchedLightsID = { 148 }; -- КоридорКухня:СветОсновной_R_Кухня:СветОсновной\nlocal checkedLightsID = { 42, 44 }; -- БольшаяКомната:СветОсновной_G_центр + БольшаяКомната:СветОсновной_W_прикроватный\n\n\n-- PROCESS\n\nfor i = 1, #switchedLightsID do\n  \n  local nodeID = switchedLightsID[i];\n  \n  if tonumber(fibaro:getValue(nodeID, \"value\")) > 0 then\n    fibaro:call(nodeID, \"turnOff\");\n    \n    fibaro:debug(\"Turning off <\" .. fibaro:getName(nodeID) .. \" (\" .. fibaro:getRoomNameByDeviceID(nodeID) .. \")>\");\n  end;\n  \nend;\n\nlocal isCheckedOn = false;\n\nfor i = 1, #checkedLightsID do\n  \n  local nodeID = checkedLightsID[i];\n  \n  if tonumber(fibaro:getValue(nodeID, \"value\")) > 0 then\n    isCheckedOn = true;\n    fibaro:debug(\"Still turned ON <\" .. fibaro:getName(nodeID) .. \" (\" .. fibaro:getRoomNameByDeviceID(nodeID) .. \")> - no Power turn off\");\n    break;\n  end;\n  \nend;\n\nif isCheckedOn == false then\n  fibaro:sleep(10000);\n  \n  fibaro:call(powerID, \"turnOff\");\n  fibaro:debug(\"Turning off Power\");\nend;\n--]]","buttonIcon":0,"favourite":false,"main":false}]},{"type":"slider","elements":[{"id":4,"lua":true,"waitForResponse":false,"caption":"диммер","name":"Slider1","msg":"val = tonumber(_sliderValue_);\nif ( val == 100 ) then\n  val = 99;\nend\n\nfibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"149,\" .. val .. \";\");\n\n--fibaro:startScene(188);\n\n--[[\n-- CONST\n\nlocal powerID = 4; -- Туалет:БП ACDC 24В\nlocal switchedLightsID = { 148 }; -- КоридорКухня:СветОсновной_R_Кухня:СветОсновной\nlocal checkedLightsID = { 42, 44 }; -- БольшаяКомната-СветОсновной,прикроватный + Кухня-СветОсновной\n\n\n-- PROCESS\n\nfibaro:log(_sliderValue_);\n      \n\nif _sliderValue_ > 0 then\n\n\n---- copy from ON button\n\nlocal powerIsOn = fibaro:getValue(powerID, \"value\");\n\nif tonumber(powerIsOn) == 0 then\n  \n  fibaro:call(powerID, \"turnOn\");\n  fibaro:debug(\"Power is OFF! Turning on\");\n  \n  fibaro:sleep(5000);\n  \nelse\n  fibaro:debug(\"Power is on\");\nend;\n\nlocal startWakeupTime = os.time();\n\nwhile os.time() < startWakeupTime + 15 do\n  \n  local isDead = false;\n  \n  for i = 1, #switchedLightsID do\n    \n    local nodeID = switchedLightsID[i];\n    \n    if fibaro:getValue(nodeID, \"dead\") >= \"1\" then\n      fibaro:wakeUpDeadDevice(nodeID);\n      fibaro:debug(\"Waking up DEAD <\" .. fibaro:getName(nodeID) .. \" (\" .. fibaro:getRoomNameByDeviceID(nodeID) .. \")>\");\n      isDead = true;\n    end;\n    \n  end;\n  \n  if isDead == false then\n    break;\n  else\n    fibaro:sleep(3000);\n  end;\n  \nend;\n\nfor i = 1, #switchedLightsID do\n  \n  local nodeID = switchedLightsID[i];\n  \n  if _sliderValue_ >= 99 then\n      fibaro:call(nodeID, \"turnOn\");\n\t  fibaro:debug(\"Turning on <\" .. fibaro:getName(nodeID) .. \" (\" .. fibaro:getRoomNameByDeviceID(nodeID) .. \")> value = \" .. fibaro:getValue(nodeID, \"value\") ..\", deadflag = \" .. fibaro:getValue(nodeID, \"dead\"));\n  else\n      fibaro:call(nodeID, \"setValue\", _sliderValue_);\n\t  fibaro:debug(\"Setting value [\" + _sliderValue_ + \"] on <\" .. fibaro:getName(nodeID) .. \" (\" .. fibaro:getRoomNameByDeviceID(nodeID) .. \")> value = \" .. fibaro:getValue(nodeID, \"value\") ..\", deadflag = \" .. fibaro:getValue(nodeID, \"dead\"));\n  end;\n  \nend;\n\n\nelse\n\n---- copy from OFF button\n\nfor i = 1, #switchedLightsID do\n  \n  local nodeID = switchedLightsID[i];\n  \n  if tonumber(fibaro:getValue(nodeID, \"value\")) > 0 then\n    fibaro:call(nodeID, \"turnOff\");\n    \n    fibaro:debug(\"Turning off <\" .. fibaro:getName(nodeID) .. \" (\" .. fibaro:getRoomNameByDeviceID(nodeID) .. \")>\");\n  end;\n  \nend;\n\nlocal isCheckedOn = false;\n\nfor i = 1, #checkedLightsID do\n  \n  local nodeID = checkedLightsID[i];\n  \n  if tonumber(fibaro:getValue(nodeID, \"value\")) > 0 then\n    isCheckedOn = true;\n    fibaro:debug(\"Still turned ON <\" .. fibaro:getName(nodeID) .. \" (\" .. fibaro:getRoomNameByDeviceID(nodeID) .. \")> - no Power turn off\");\n    break;\n  end;\n  \nend;\n\nif isCheckedOn == false then\n  fibaro:sleep(10000);\n  \n  fibaro:call(powerID, \"turnOff\");\n  fibaro:debug(\"Turning off Power\");\nend;\n\n\nend\n--]]","buttonIcon":0,"value":0,"favourite":false,"main":true}]},{"type":"button","elements":[{"id":5,"lua":true,"waitForResponse":false,"caption":"переключатель","name":"Button21","empty":false,"msg":"local lightAction = \"\";\n\nif ( (fibaro:getValue(149, \"value\") == \"0\")\n\tor (fibaro:getValue(149, \"dead\") ~= \"0\")\n\tor (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  ) then\n  lightAction = \"149,200;\";\nelse\n  if ( tonumber(fibaro:getValue(149, \"value\")) <= 50 ) then\n    lightAction = \"150,125;149,-1;\"; -- \"follow light\"\n  else\n    lightAction = \"149,-1;\";\n  end\nend\n\nfibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. lightAction);\n\n--[[\nfibaro:debug(fibaro:getValue(196, \"ui.Slider1.value\"));\nif fibaro:getValue(196, \"ui.Slider1.value\") == \"0\"\nthen\n  if fibaro:getGlobalValue(\"nightMode\") == \"1\"\n  then\n    fibaro:call(196, \"pressButton\", \"2\");\n  else\n    fibaro:call(196, \"pressButton\", \"1\");\n  end\nelse\n  fibaro:call(196, \"pressButton\", \"3\");\nend\n--]]\n","buttonIcon":0,"favourite":false,"main":true}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}