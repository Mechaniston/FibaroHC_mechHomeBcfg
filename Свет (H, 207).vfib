{"name":"Свет","type":"virtual_device","properties":{"deviceIcon":0,"currentIcon":"0","log":"35.20Вт","logTemp":"TxtGreen","mainLoop":"local sum = 0;\nlocal val = 0;\nlocal nodesID = { 150,151 }; -- HKL_rGbw_ent & HKL_rgBw_deep\nlocal slidersNameSuffs = { \"2\", \"3\" };\n\nfor i = 1, #nodesID do\n  \n  local nodeID = nodesID[i];\n  local nodeValue = tonumber(fibaro:getValue(nodeID, \"value\"));\n  \n  if ( (nodeValue > 0) and (fibaro:getValue(nodeID, \"dead\") == \"0\") )\n  then\n    if (nodeValue >= 99)\n    then\n      nodeValue = 100;\n    else\n      --exact nodeValue;\n    end\n    --[[if (nodeValue > sum) -- find MAX\n    then\n      sum = nodeValue;\n    end--]]\n  else\n    nodeValue = 0;\n  end\n  \n  sum = sum + nodeValue;\n  \n  fibaro:call(207, \"setProperty\", \"ui.Slider\" .. slidersNameSuffs[i] .. \".value\",\n    nodeValue);\n  \nend\n\nlocal sliderPos = math.ceil(sum / #nodesID); --sum -- for MAX value\n\nif (sliderPos > 0 and sliderPos < 3)\nthen\n  sliderPos = 3;\nelseif (sliderPos >= 99)\nthen\n  sliderPos = 100;\nend\n\nfibaro:call(207, \"setProperty\", \"ui.Slider1.value\", sliderPos);\n\n--[[\nlocal nodeID = 150;\nlocal nodeValue = tonumber(fibaro:getValue(nodeID, \"value\"));\n\nif (nodeValue > 0)\nthen\n  --fibaro:debug(\"#\" .. tostring(nodeID) .. \" value = \" .. tostring(nodeValue));\n  if (fibaro:getValue(nodeID, \"dead\") ~= \"0\")\n  then\n    --fibaro:debug(\"#\" .. tostring(nodeID) .. \" is DEAD!\");\n    nodeValue = 0;\n  elseif (nodeValue >= 99)\n  then\n    --fibaro:debug(\"#\" .. tostring(nodeID) .. \" is MAX\");\n    nodeValue = 100;\n  elseif (nodeValue < 3)\n  then\n    --fibaro:debug(\"#\" .. tostring(nodeID) .. \" is MIN\");\n    nodeValue = 3\n  end\nend\n\nfibaro:call(207, \"setProperty\", \"ui.Slider1.value\", tostring(nodeValue));\n--]]\n\n----\n\nlocal powerValue = 0;\n\nif ( fibaro:getValue(147, \"dead\") == \"0\" ) then\n  powerValue = tonumber(fibaro:getValue(147, \"power\"));\nend\n\nlocal power = string.format(\"%.2f\", powerValue); -- powerVakue * sliderPos / 100);\n\nfibaro:call(207, \"setProperty\", \"ui.Label1.value\", power .. \"Вт\");\nfibaro:log(power .. \"Вт\");\n\nfibaro:sleep(5000);\n","ui.Label1.value":"35.20Вт","ui.Slider1.value":50,"ui.Slider2.value":0,"ui.Slider3.value":100,"visible":"true","rows":[{"type":"button","elements":[{"id":1,"lua":true,"waitForResponse":false,"caption":"ВКЛ","name":"Button11","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"150,100;151,100;\");\n--fibaro:call(207, \"setProperty\", \"ui.Slider1.value\", \"100\");\n--fibaro:startScene(188);","buttonIcon":0,"favourite":false,"main":false},{"id":2,"lua":true,"waitForResponse":false,"caption":"МИН","name":"Button12","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"150,1;151,1;\");\n--fibaro:call(207, \"setProperty\", \"ui.Slider1.value\", \"1\");\n--fibaro:startScene(188);\n--fibaro:call(207, \"setProperty\", \"ui.Slider1.value\", \"3\");","buttonIcon":0,"favourite":false,"main":false},{"id":3,"lua":true,"waitForResponse":false,"caption":"ВЫКЛ","name":"Button13","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"150,0;151,0;\");\n--fibaro:call(207, \"setProperty\", \"ui.Slider1.value\", \"0\");\n--fibaro:startScene(188);","buttonIcon":0,"favourite":false,"main":false}]},{"type":"slider","elements":[{"id":4,"lua":true,"waitForResponse":false,"caption":"диммер","name":"Slider1","msg":"local lightAction = \"\";\n\nif ( fibaro:getValue(150, \"value\") ~= \"0\" ) then\n  lightAction = lightAction .. \"150,\" .. _sliderValue_ .. \";\";\nend\n\nif ( fibaro:getValue(151, \"value\") ~= \"0\" ) then\n  lightAction = lightAction .. \"151,\" .. _sliderValue_ .. \";\";\nend\n\nif ( lightAction == \"\" ) then\n  lightAction =\n\t\"150,\" .. _sliderValue_ .. \";\"\n\t.. \"151,\" .. _sliderValue_ .. \";\";\nend\n\nfibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. lightActions);","buttonIcon":0,"value":50,"favourite":false,"main":true}]},{"type":"button","elements":[{"id":5,"lua":true,"waitForResponse":false,"caption":"переключатель","name":"Button21","empty":false,"msg":"if\n  -- Light ON priority - turn all on if something is off\n  --[[( (fibaro:getValue(150, \"value\") == \"0\")\n\tor (fibaro:getValue(150, \"dead\") >= \"1\")\n\tor (fibaro:getValue(151, \"value\") == \"0\")\n    or (fibaro:getValue(151, \"dead\") >= \"1\")\n    or (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  )--]]\n  -- Light OFF priority - turn all off if something ison\n  ( (\n    ( (fibaro:getValue(150, \"value\") == \"0\")\n      or (fibaro:getValue(260, \"dead\") ~= \"0\") )\n    and\n    ( (fibaro:getValue(151, \"value\") == \"0\")\n      or (fibaro:getValue(151, \"dead\") ~= \"0\") )\n    )\n    or (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  ) then\n  fibaro:debug(\"Switch ON (_ent = \"\n    .. fibaro:getValue(150, \"value\")\n    .. \", _deep = \"\n    .. fibaro:getValue(151, \"value\") .. \")\");\n  \n  --fibaro:setGlobal(\"lightsQueue\", fibaro:getGlobalValue(\"lightsQueue\")\n  --  .. \"150,150;151,200;\");\n  -- for wife & child pleasure )) more smart a bit ))))\n  \n  local hallLux = fibaro:getValue(296, \"value\"); -- К:Освещенность\n  local isLightInRoom = -- simple sleep detection\n    ( tonumber(fibaro:getValue(40, \"value\")) > 0 ) -- ctrlBigRoom:СветОснОбщ\n  --  or ( tonumber(fibaro:getValue(228, \"value\")) > 0 ) -- БК:УпрРозетка (- бра напол.)\n    or ( tonumber(fibaro:getValue(230, \"value\")) > 0 ) -- БК:Бра(настен.)\n  \n  fibaro:debug(\"hallLux = \" .. hallLux);\n  fibaro:debug(\"isLightInRoom = \" .. tostring(isLightInRoom));\n  \n  if not isLightInRoom then\n    --local currentTime = os.date(\"*t\");\n    --if ( (currentTime.hour >= 22) or (currentTime.hour <= 8) ) then\n    if ( fibaro:getGlobalValue(\"twilightMode\") == \"1\" ) then\n      fibaro:setGlobal(\"lightsQueue\",\n        fibaro:getGlobalValue(\"lightsQueue\")\n        .. \"150,110;\");\n    else\n      fibaro:setGlobal(\"lightsQueue\",\n        fibaro:getGlobalValue(\"lightsQueue\")\n        .. \"150,150;\");\n    end\n  else  \n    if ( tonumber(hallLux) > 10 ) then\n      fibaro:setGlobal(\"lightsQueue\",\n        fibaro:getGlobalValue(\"lightsQueue\")\n        .. \"150,150;\");\n    else\n      fibaro:setGlobal(\"lightsQueue\",\n        fibaro:getGlobalValue(\"lightsQueue\")\n        .. \"150,200;\");\n    end\n  end\nelse\n  fibaro:debug(\"Switch OFF\");\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"150,-1;151,-1;\");\nend\n\n--[[\n--fibaro:debug(fibaro:getValue(207, \"ui.Slider1.value\"));\nif fibaro:getValue(207, \"ui.Slider1.value\") == \"0\"\nthen\n  if fibaro:getGlobalValue(\"nightMode\") == \"1\"\n  then\n    fibaro:call(207, \"pressButton\", \"2\");\n  else\n    fibaro:call(207, \"pressButton\", \"1\");\n  end\nelse\n  fibaro:call(207, \"pressButton\", \"3\");\nend\n--]]\n","buttonIcon":0,"favourite":false,"main":true}]},{"type":"slider","elements":[{"id":6,"lua":true,"waitForResponse":false,"caption":"- у входа:","name":"Slider2","msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"150,\" .. _sliderValue_ .. \";\");","buttonIcon":0,"value":0,"favourite":false,"main":false}]},{"type":"slider","elements":[{"id":7,"lua":true,"waitForResponse":false,"caption":"- у шкафа:","name":"Slider3","msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"151,\" .. _sliderValue_ .. \";\");","buttonIcon":0,"value":100,"favourite":false,"main":false}]},{"type":"label","elements":[{"id":8,"lua":false,"waitForResponse":false,"caption":"Потребление:","name":"Label1","favourite":false,"main":true}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}