{"name":"Свет","type":"virtual_device","properties":{"deviceIcon":0,"currentIcon":"0","log":"120.60Вт","logTemp":"TxtGreen","mainLoop":"local sum = 0;\nlocal names = \"\";\nlocal nodesID = { 261, 262, 266 };\nlocal nodesName = { \"Л\", \"Ц\", \"П\" };\n\nfor i = 1, #nodesID do\n  \n  local nodeID = nodesID[i];\n  local nodeValue = tonumber(fibaro:getValue(nodeID, \"value\"));\n  \n  if ( (nodeValue > 0) and (fibaro:getValue(nodeID, \"dead\") == \"0\") ) then\n    names = names .. nodesName[i];\n    \n    if (nodeValue >= 99) then\n      sum = sum + 100;\n    else\n      sum = sum + nodeValue;\n    end\n  end\n  \nend\n\nlocal sliderPos = math.ceil(sum / #nodesID); --sum -- for MAX value\n\nif (sliderPos > 0 and sliderPos < 3) then\n  sliderPos = 3;\nelseif (sliderPos >= 99) then\n  sliderPos = 100;\nend\n\nfibaro:call(272, \"setProperty\", \"ui.Slider1.value\", tostring(sliderPos));\n\nfibaro:call(195, \"setProperty\", \"ui.Label1.value\", names);\n\n----\n\nlocal powerValue = 0;\n\nif ( (fibaro:getValue(259, \"dead\") == \"0\")\n    and (fibaro:getValue(259, \"value\") ~= \"0\") ) then\n  powerValue = tonumber(fibaro:getValue(259, \"power\"));\nend\n\nif ( (fibaro:getValue(266, \"dead\") == \"0\")\n    and (fibaro:getValue(266, \"value\") ~= \"0\") ) then\n  powerValue = powerValue + tonumber(fibaro:getValue(266, \"power\"));\nend\n\nlocal power = string.format(\"%.2f\", powerValue);\n\nfibaro:call(272, \"setProperty\", \"ui.Label2.value\", power .. \"Вт\");\nfibaro:log(power .. \"Вт\");\n\n-----\n\nfibaro:sleep(5000);\n","ui.Label1.value":"","ui.Label2.value":"120.60Вт","ui.Slider1.value":100,"visible":"true","rows":[{"type":"button","elements":[{"id":1,"lua":true,"waitForResponse":false,"caption":"ВКЛ","name":"Button11","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"261,100;262,100;266W,100;\");","buttonIcon":0,"favourite":false,"main":false},{"id":2,"lua":true,"waitForResponse":false,"caption":"МИН","name":"Button12","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"261,1;262,1;266W,1;\");","buttonIcon":0,"favourite":false,"main":false},{"id":3,"lua":true,"waitForResponse":false,"caption":"ВЫКЛ","name":"Button13","empty":false,"msg":"fibaro:setGlobal(\"lightsQueue\",\n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. \"260,0;266,0;\");","buttonIcon":0,"favourite":false,"main":false}]},{"type":"slider","elements":[{"id":4,"lua":true,"waitForResponse":false,"caption":"диммер","name":"Slider1","msg":"local lightsAction = \"\";\n\nval = tonumber(_sliderValue_);\nif ( val == 100 ) then\n  val = 99;\nend\n\nif ( fibaro:getValue(261, \"value\") ~= \"0\" ) then\n  lightsAction = lightsAction .. \"261,\"\n    .. val .. \";\";\nend\n\nif ( fibaro:getValue(262, \"value\") ~= \"0\" ) then\n  lightsAction = lightsAction .. \"262,\"\n    .. val .. \";\";\nend\n\nif ( fibaro:getValue(266, \"value\") ~= \"0\" ) then\n  lightsAction = lightsAction .. \"266,\"\n    .. val .. \";\";\nend\n\nif ( lightsAction == \"\" ) then\n  lightsAction =\n\t\"261,\" .. val .. \";\"\n\t.. \"262,\" .. val .. \";\"\n\t.. \"266W,\" .. val .. \";\";\nend\n\nfibaro:setGlobal(\"lightsQueue\", \n  fibaro:getGlobalValue(\"lightsQueue\")\n  .. lightsAction);\n","buttonIcon":0,"value":34,"favourite":false,"main":true}]},{"type":"button","elements":[{"id":5,"lua":true,"waitForResponse":false,"caption":"переключатель","name":"Button21","empty":false,"msg":"if\n  -- Light ON priority - turn all on if something is off\n  --[[( (fibaro:getValue(260, \"value\") == \"0\")\n    or (fibaro:getValue(260, \"dead\") >= \"1\")\n    or (fibaro:getValue(266, \"value\") == \"0\")\n    or (fibaro:getValue(266, \"dead\") >= \"1\")\n    or (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  )--]]\n  -- Light OFF priority - turn all off if something ison\n  ( (\n    ( (fibaro:getValue(260, \"value\") == \"0\")\n      or (fibaro:getValue(260, \"dead\") >= \"1\") )\n    and\n    ( (fibaro:getValue(266, \"value\") == \"0\")\n      or (fibaro:getValue(266, \"dead\") >= \"1\") )\n    )\n    or (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  ) then\n  \n  fibaro:debug(\"Switch ON (GenLght = \"\n    .. fibaro:getValue(260, \"value\")\n    .. \", AuxLight = \"\n    .. fibaro:getValue(266, \"value\") .. \")\");\n  \n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"261,200;262,200;266W,200;\");\n  \nelse\n  \n  fibaro:debug(\"Switch OFF\");\n  \n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"260,-1;266,-1;\");\n  \nend","buttonIcon":0,"favourite":false,"main":true}]},{"type":"label","elements":[{"id":6,"lua":false,"waitForResponse":false,"caption":"- поканально:","name":"Label1","favourite":false,"main":false}]},{"type":"button","elements":[{"id":7,"lua":true,"waitForResponse":false,"caption":"слева","name":"Button31","empty":false,"msg":"if ( (fibaro:getValue(261, \"value\") == \"0\")\n\tor (fibaro:getValue(261, \"dead\") >= \"1\")\n    or (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  ) then\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"261,100;\");\nelse\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"261,0;\");\nend","buttonIcon":0,"favourite":false,"main":false},{"id":8,"lua":true,"waitForResponse":false,"caption":"центр","name":"Button32","empty":false,"msg":"if ( (fibaro:getValue(262, \"value\") == \"0\")\n\tor (fibaro:getValue(262, \"dead\") >= \"1\")\n\tor (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  ) then\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"262,100;\");\nelse\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"262,0;\");\nend","buttonIcon":0,"favourite":false,"main":false},{"id":9,"lua":true,"waitForResponse":false,"caption":"справа","name":"Button33","empty":false,"msg":"if ( (fibaro:getValue(266, \"value\") == \"0\")\n  or (fibaro:getValue(266, \"dead\") >= \"1\")\n  or (fibaro:getValue(4, \"value\") == \"0\") -- PowerSource\n  ) then\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"266W,100;\");\n    --fibaro:call(266, \"setW\", 255);\nelse\n  fibaro:setGlobal(\"lightsQueue\",\n    fibaro:getGlobalValue(\"lightsQueue\")\n    .. \"266,0;\");\nend","buttonIcon":0,"favourite":false,"main":false}]},{"type":"label","elements":[{"id":10,"lua":false,"waitForResponse":false,"caption":"Потребление:","name":"Label2","favourite":false,"main":true}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}